# ScriptMapper 公式仕様書

> **調査元**: [hibit-at/Scriptmapper](https://github.com/hibit-at/Scriptmapper)  
> **調査日**: 2024-12-23  
> **バージョン**: 1.09 (Latest)

## 概要

ScriptMapperは、Beat Saberのマッピングソフト上でブックマークに命令（スクリプト）を記述することで、カメラスクリプト（`SongScript.json`）を自動生成するツールです。

---

## 基本書式

### ブックマーク構造

```
startコマンド,endコマンド[,トランジション]
```

- **カンマ（`,`）** でstart/endコマンドを区切る
- **スクリプトの持続期間**: 現在のブックマーク位置から次のブックマーク位置まで
- **endコマンド省略時**: 自動的に `stop` が挿入される

### パラメータ形式

パラメータは以下の形式で指定可能:
- 整数: `40`
- 負数: `-40`
- 小数点開始: `.5` (= 0.5)
- 分数: `5/4` (= 1.25)
- 計算式: `2*(-1)**!` (fill内でのイテレーション変数使用時)

---

## プリセットコマンド

### 基本コマンド（位置コマンド）

| コマンド | 説明 | パラメータ | 例 |
|---------|------|-----------|-----|
| `center` | 真正面または真後ろからアバターを見る位置 | 前方向位置(m) | `center1`, `center-2` |
| `top` | アバターの真上やや前方 | 高さ(m) | `top3` |
| `side` | 真横にカメラを置く（高さ1.5m固定） | 右手方向位置(m) | `side3`, `side-2` |
| `diagf` | 斜め前方（高さ3m固定） | 右手前方向位置(m) | `diagf3` |
| `diagb` | 斜め後方（高さ3m固定） | 右手後方向位置(m) | `diagb3` |
| `random` | ランダムな座標 | 半径(m) | `random3` |

**注意**: 
- `center` の位置は前方なら目線の高さ、後方なら見下ろす位置
- 位置パラメータはメートル基準、角度は度数法（ラジアンではない）

### 中級コマンド（変換コマンド）

直前の座標に操作を加えるコマンド。

| コマンド | 説明 | パラメータ | 例 |
|---------|------|-----------|-----|
| `stop` | 直前の座標でカメラを止める | - | `stop` |
| `mirror` | 左右方向に鏡像反転 | - | `mirror` |
| `zoom` | FOVを小さくする | 角度(度) | `zoom15` |
| `spin` | Z軸回転（ロール） | 反時計回り角度 | `spin-40` |
| `slide` | 左右方向に移動 | 右方向位置(m) | `slide.5` |
| `shift` | 上下方向に移動 | 上方向位置(m) | `shift.5` |
| `push` | 前後方向に移動 | 前方向位置(m) | `push1` |
| `turn` | アバター中心に水平回転 | 反時計回り角度 | `turn20` |
| `screw` | spinとzoomの複合 | 角度 | `screw15` |

**使用例**:
- `stop` - 直前の座標で固定
- `mirror` - 直前の座標を鏡像反転した座標で固定
- `stop,mirror` - 直前座標から鏡像反転座標まで連続的に変化

---

## 詳細座標コマンド

### dposコマンド

アバターを自動で向く座標指定（角度自動計算）。

```
dpos_X_Y_Z_FOV
```

| パラメータ | 説明 |
|-----------|------|
| X | カメラX座標 |
| Y | カメラY座標 |
| Z | カメラZ座標 |
| FOV | 視野角 |

**例**: `dpos_0_0.5_-2_40` - 座標(0, 0.5, -2)、FOV 40

### qコマンド

完全な座標・角度指定。

```
q_X_Y_Z_RX_RY_RZ_FOV
```

| パラメータ | 説明 |
|-----------|------|
| X, Y, Z | カメラ座標 |
| RX, RY, RZ | カメラ角度（非ラジアン） |
| FOV | 視野角 |

**例**: `q_0_0.5_-2_-10_0_0_40` - 完全な7パラメータ指定

---

## パラメータ直接調整（$構文）

`$` を使ってパラメータを個別調整。

| 記号 | 対象 |
|-----|------|
| `X`, `Y`, `Z` | 座標 |
| `x`, `y`, `z` | 角度 |
| `F` | 視野角(FOV) |

**例**:
- `center-2$X0.5` - center-2のX座標だけ0.5に修正
- `center-2$x10$F40` - center-2のX角度を10、FOVを40に修正

---

## 制御コマンド

### nextコマンド

次のブックマークの開始位置まで移動。

```
A,next → B
```

`A` から `B` の開始位置まで連続的に移動。

### -> コマンド

前のブックマークからの連続移動。

```
center-2 → ->diagb2
```

`center-2,diagb2` と同等（内部的に `stop,` に変換）。

---

## 上級コマンド（連続動作）

### rotate

アバター中心の回転軌道。

```
rotate[r1],[h1],[a],[o],[s1],[j],[w],[r2],[h2],[s2]
```

| パラメータ | 説明 | デフォルト |
|-----------|------|-----------|
| r1 | 半径(m) | 3 |
| h1 | 高さ(m) | 3 |
| a | ターゲット高さ(m) | 1 |
| o | 前後オフセット(m) | 1.0 |
| s1 | カメラ傾き | 0 |
| j | 開始角度(度) | 0 |
| w | 回転角度(度) | 360 |
| r2 | 終了半径(m) | r1と同じ |
| h2 | 終了高さ(m) | h1と同じ |
| s2 | 終了傾き | s1と同じ |

**例**: `rotate4,3` - 半径4m、高さ3mの円軌道

### vibro

ランダムな微小移動（手ブレ表現）。

```
vibro[周期]
```

**例**: `vibro1/6` - 周期1/6グリッドで振動

---

## イージングコマンド

### サポートされているイージング関数

```python
easetypes = [
    'InSine', 'OutSine', 'InOutSine',
    'InCubic', 'OutCubic', 'InOutCubic',
    'InQuint', 'OutQuint', 'InOutQuint',
    'InCirc', 'OutCirc', 'InOutCirc',
    'InElastic', 'OutElastic', 'InOutElastic',
    'InQuad', 'OutQuad', 'InOutQuad',
    'InQuart', 'OutQuart', 'InOutQuart',
    'InExpo', 'OutExpo', 'InOutExpo',
    'InBack', 'OutBack', 'InOutBack',
    'InBounce', 'OutBounce', 'InOutBounce',
    'Drift'
]
```

**参考**: [easings.net](https://easings.net/ja)

### イージングの書式

```
startコマンド,endコマンド,イージング
```

**例**:
- `center1,diagb3,OCubic` - OutCubicでイーズアウト
- `center1,diagb3,IOBounce` - InOutBounceで緩急

### 表記の短縮

| 短縮形 | フル表記 |
|-------|---------|
| `I` + 関数名 | `In` + 関数名 |
| `O` + 関数名 | `Out` + 関数名 |
| `IO` + 関数名 | `InOut` + 関数名 |

**例**:
- `OCubic` = `OutCubic`
- `IOBounce` = `InOutBounce`

### Drift関数

特殊なイージング関数で、パラメータで緩急を調整可能。

```
Drift_X_Y
```

X, Y は 0-10 の範囲で指定（内部で 1/10 にスケール）。

---

## 特殊トランジション

### rot

回転しながら移動。

```
startコマンド,endコマンド,rot[n]_[o]
```

| パラメータ | 説明 |
|-----------|------|
| n | 回転数（正:反時計回り、負:時計回り） |
| o | オフセット位置 |

**例**: `center3,side3,rot1_0` - 反時計回りに回転移動

### vib

振動しながら移動。

```
startコマンド,endコマンド,vib[周期]
```

**例**: `diagf3,center2,vib1/2` - 周期1/2で振動しながら移動

---

## 特殊コマンド

### copy

ブックマークを範囲コピー。

```
copy[開始グリッド]
```

100グリッド目で`copy40`、次のブックマークが120の場合:
- コピー先: 100-120（長さ20）
- コピー元: 40-60（同じ長さ）

### fill

パターンを反復複製。

```
fill[スパン],[パターン]
```

**例**:
- `fill1/4,random3` - 1/4グリッド間隔でrandom3を繰り返し
- `fill1/4,random3,zoom2` - 1/4グリッド間隔でrandom3,zoom2を繰り返し
- `fill2,mirror` - 2グリッド間隔でmirrorを繰り返し

### fill内の変数

| 記号 | 意味 |
|-----|------|
| `!` | イテレーション（反復回数、0から開始） |
| `?` | 乱数 |

**例**: `fill1,center1+!` → `center1`, `center2`, `center3`...

---

## 環境コマンド

`#` で始まるブックマークは環境コマンドとして認識。

### 環境設定

| コマンド | 説明 | 例 |
|---------|------|-----|
| `#fov` | 環境FOVを変更（デフォルト: 60） | `#fov60` |
| `#seed` | 乱数シードを設定（デフォルト: 0） | `#seed0` |
| `#head` | 頭部追従モードを切り替え | `#head` |
| `#height` | アバター頭部の高さ（デフォルト: 1.5m） | `#height1.5` |

### オブジェクト表示/非表示

```
#[オブジェクト名]ON
#[オブジェクト名]OFF
```

| オブジェクト | 説明 |
|-------------|------|
| `avatar` | アバター |
| `ui` | UI（点数・コンボ表示など） |
| `wallFrame` | 壁の枠 |
| `wall` | 壁の中身 |
| `saber` | セイバー |
| `notes` | ノーツ |
| `debris` | ノーツの破片 |

**例**: `#avatarOFF` → 次のブックマークからアバター非表示

---

## オリジナルコマンド

`input.csv` でカスタムコマンドを定義。

### CSV形式

| 列 | 説明 |
|----|------|
| label | コマンド名 |
| px, py, pz | カメラ座標 |
| lookat | true: 自動でアバターを向く |
| rx, ry, rz | カメラ角度（lookatがfalseの場合） |
| FOV | 視野角 |

**注意**: オリジナルコマンドはプリセットより優先

---

## FAQ

### Q: rotateやvibroコマンドをイージングすることは可能？
A: 現状では不可能です。

### Q: プリセットコマンドとオリジナルコマンドの優先順位は？
A: オリジナルコマンドが優先。前方一致で判定。

---

## 参照URL

- **公式リポジトリ**: https://github.com/hibit-at/Scriptmapper
- **Wiki（上級ドキュメント）**: https://github.com/hibit-at/Scriptmapper/wiki/Advanced-Document
- **イージング参考**: https://easings.net/ja
- **座標プレビュー**: https://rotatescript.herokuapp.com/params/
- **ChroMapper-CameraMovement**: https://github.com/rynan4818/ChroMapper-CameraMovement

---

## EasingVisualizerでの対応状況

### サポート済み

| 機能 | 状態 | 備考 |
|------|------|------|
| イージング関数（30種） | ✅ | 全関数対応 |
| Drift関数 | ✅ | x, yパラメータ対応 |
| 短縮表記（I/O/IO） | ✅ | 自動変換対応 |
| qコマンド（座標インポート） | ✅ | 7パラメータ解析 |
| dposコマンド（座標インポート） | ✅ | 4パラメータ解析 |

### 対象外（カメラ位置は別ツールで管理）

| 機能 | 理由 |
|------|------|
| center, top, side等 | 位置計算はChroMapper-CameraMovement等で実施 |
| rotate, vibro | 連続動作コマンドは別途管理 |
| copy, fill | エディタ機能 |
| 環境コマンド | ゲーム設定 |

---

## 変更履歴

- 2024-12-23: 初版作成（公式リポジトリ調査に基づく）
